<div class="modal-header">
  <h5 class="modal-title">Documentos - Entrega</h5>
  <button type="button" class="btn-close" aria-label="Close" (click)="cerrar()"></button>
</div>
<div class="modal-body">
  <div class="row mb-2">
    <div class="col-4">
      <label class="form-label">ENTREGABLE</label>
      <input class="form-control form-control-sm" [value]="entregable" disabled />
    </div>
    <div class="col-4">
      <label class="form-label">FECHA ENTREGA</label>
      <input class="form-control form-control-sm" [value]="fechaEntrega" disabled />
    </div>
    <div class="col-4">
      <label class="form-label">DESCRIPCIÓN CONTROL</label>
      <input class="form-control form-control-sm" [value]="descripcionControl" disabled />
    </div>
  </div>

  <div class="row">
    <div class="col-xxl-12 col-md-6">
      <div>
        <label class="form-label"><strong>Adjuntar Archivos </strong> | <i> Puede adjuntar hasta 10 archivos (máximo 5 MB cada uno). Formatos permitidos: PDF, JPG, JPEG y PNG.</i></label>
        <ngx-dropzone #dz
          [disableClick]="true"
          (change)="onSelect($event)"
          accept="image/jpeg,image/jpg,image/png,application/pdf">

          <ngx-dropzone-label style="cursor:pointer" (click)="onLabelClick($event)">
            Arrastra tus archivos o haz clic para seleccionar
          </ngx-dropzone-label>

          <ng-container *ngFor="let f of existingFiles; let i = index">
            <div class="preview-wrapper">
              <ngx-dropzone-preview
                [file]="{ name: f.edo_nomfil, type: f.tipo, size: 0 }"
                [removable]="false"
                (click)="verArchivoExisting(f)"
                style="cursor: pointer;"
              >
                <ngx-dropzone-label>
                  <div class="dz-file">
                    <ng-template [ngIf]="f.tipo && f.tipo.startsWith('image/')">
                      <i class="ri-image-2-line dz-icon"></i>
                    </ng-template>
                    <ng-template [ngIf]="!f.tipo || !f.tipo.startsWith('image/')">
                      <i class="ri-file-pdf-line dz-icon" *ngIf="f.tipo==='application/pdf'"></i>
                      <i class="ri-file-2-line dz-icon" *ngIf="f.tipo!=='application/pdf'"></i>
                    </ng-template>
                    <div class="dz-text">
                      <div class="dz-name">{{ f.edo_numdoc }}</div>
                      <div class="dz-meta">{{ getFileSize(f.edo_tamfil) }}</div>
                      <div class="dz-meta">Existente</div>
                    </div>
                  </div>
                </ngx-dropzone-label>
              </ngx-dropzone-preview>

              
              <button
                *ngIf="f.chk_botanu == 1"
                class="file-remove-btn visible"
                title="Eliminar archivo"
                (click)="onRemoveExisting(f); $event.stopPropagation();">
                <i class="ri-close-line"></i>
              </button>

              <button
                *ngIf="f.chk_botanu != 1"
                class="file-remove-btn disabled visible"
                title="Sin permiso para eliminar"
                disabled>
                <i class="ri-lock-line"></i>
              </button>
            </div>
          </ng-container>


          <ngx-dropzone-preview style="cursor: pointer;" *ngIf="totalFiles < MAX_FILES && !uploading" (click)="onAddClick($event, dz)">
            <ngx-dropzone-label>
              <div class="dz-file">
                <i class="ri-add-box-fill"></i>
                <div class="dz-text">
                  <div class="dz-name">AGREGAR</div>
                  <div class="dz-meta">ARCHIVOS</div>
                </div>
              </div>
            </ngx-dropzone-label>
          </ngx-dropzone-preview>

          <ng-container *ngFor="let f of files">
            <ngx-dropzone-image-preview
              *ngIf="f.type && f.type.startsWith('image/')"
              [file]="f"
              [removable]="true"
              (removed)="onRemove(f)"
              (click)="verArchivoNew(f)"
              style="cursor: pointer;">
              <ngx-dropzone-label>{{ f.name }} ({{ f.type || 'imagen' }})</ngx-dropzone-label>
            </ngx-dropzone-image-preview>

            <ngx-dropzone-preview
              *ngIf="!f.type || !f.type.startsWith('image/')"
              [file]="f"
              [removable]="true"
              (removed)="onRemove(f)"
              (click)="verArchivoNew(f)"
              style="cursor: pointer;">
              <ngx-dropzone-label>
                <div class="dz-file">
                  <ng-container *ngIf="f.type && f.type.startsWith('image/'); else fileIcon">
                    <img [src]="f.objectURL" style="max-height:80px;max-width:100px;object-fit:contain" />
                  </ng-container>
                  <ng-template #fileIcon>
                    <i class="ri-file-pdf-line dz-icon" *ngIf="f.type==='application/pdf'"></i>
                    <i class="ri-file-2-line dz-icon" *ngIf="f.type!=='application/pdf'"></i>
                  </ng-template>
                  <div class="dz-text">
                    <div class="dz-name">{{ f.name }}</div>
                    <div class="dz-meta">{{ f.type || 'archivo' }}</div>
                    <div class="dz-meta">{{ getFileSize(f) }}</div>
                    <div class="dz-meta">Añadido</div>
                  </div>
                </div>
              </ngx-dropzone-label>
            </ngx-dropzone-preview>
          </ng-container>

        </ngx-dropzone>
      </div>
    </div>
  </div>
</div>
<div class="modal-footer">
  <div class="me-auto" style="align-self:center;min-width:240px;">
    <ng-container *ngIf="uploading">
      <div class="progress" style="height:18px;">
        <div class="progress-bar bg-success" role="progressbar" [style.width.%]="uploadProgress" aria-valuemin="0" aria-valuemax="100">{{uploadProgress}}%</div>
      </div>
    </ng-container>
  </div>
  <button class="btn btn-secondary" (click)="cerrar()" [disabled]="uploading">Cerrar</button>
  <button class="btn btn-primary" (click)="guardar()" [disabled]="uploading || (!files.length && !pendingDeletes.length)">Guardar</button>
</div>

  
  <ng-template #previewTpl>
    <div class="modal-header">
      <h5 class="modal-title">{{ previewName }}</h5>
      <button type="button" class="btn-close" aria-label="Close" (click)="cerrarPreview()"></button>
    </div>
    <div class="modal-body" style="padding: 0;">
      <ng-container *ngIf="isPdf; else imgTpl">
        <div style="width: 100%; height: 80vh; display: flex; justify-content: center; align-items: center;">
          <iframe [src]="previewSrc" style="width:100%; height:100%; border: none;" allowfullscreen>
          </iframe>
        </div>
      </ng-container>
      <ng-template #imgTpl>
        <div style="display: flex; justify-content: center; align-items: center; min-height: 60vh;">
          <img 
            [src]="previewSrc" 
            style="max-width:100%; max-height: 70vh; width: auto; height: auto;" 
            (error)="handleImageError($event)" />
        </div>
      </ng-template>
    </div>
    <div class="modal-footer">
      <a *ngIf="isDirectUrl" [href]="previewSrc" class="btn btn-primary btn-sm me-2" download="{{previewName}}">
        <i class="ri-download-line"></i> Descargar
      </a>
      <button class="btn btn-danger btn-sm" (click)="cerrarPreview()">
        <i class="ri-close-line"></i> Cerrar
      </button>
    </div>
  </ng-template>
